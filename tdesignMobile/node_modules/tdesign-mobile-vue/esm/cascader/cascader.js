/**
 * tdesign v1.2.3
 * (c) 2024 TDesign Group
 * @license MIT
 */

import _toConsumableArray from '@babel/runtime/helpers/toConsumableArray';
import _slicedToArray from '@babel/runtime/helpers/slicedToArray';
import { ChevronRightIcon, CloseIcon } from 'tdesign-icons-vue-next';
import { defineComponent, toRefs, ref, computed, reactive, watch, onMounted, getCurrentInstance, h, toRaw, resolveComponent, openBlock, createBlock, withCtx, createElementVNode, normalizeClass, createElementBlock, Fragment, createTextVNode, toDisplayString, createCommentVNode, renderList, createVNode, normalizeStyle, Transition } from 'vue';
import _Popup from '../popup/index.js';
import { Tabs, TabPanel } from '../tabs/index.js';
import { RadioGroup } from '../radio/index.js';
import config from '../config.js';
import TdCascaderProps from './props.js';
import '../shared/index.js';
import { useConfig } from '../config-provider/useConfig.js';
import TNodeComponent from '../shared/render-tnode.js';
import { useVModel } from '../shared/useVModel/index.js';
import { renderTNode } from '../shared/render.js';
import '../popup/popup.js';
import '@babel/runtime/helpers/defineProperty';
import '../popup/props.js';
import '../overlay/index.js';
import '../shared/dom.js';
import 'lodash/isFunction';
import 'lodash/isString';
import '../shared/util.js';
import 'lodash/isNumber';
import '../overlay/props.js';
import '../hooks/useClass.js';
import '../hooks/tnode.js';
import 'lodash/camelCase';
import 'lodash/kebabCase';
import '../hooks/render-tnode.js';
import 'lodash/isEmpty';
import 'lodash/isObject';
import '../overlay/style';
import '../shared/component.js';
import 'lodash/cloneDeep';
import '../config-provider/context.js';
import 'lodash/mergeWith';
import 'lodash/merge';
import 'lodash/isArray';
import '../_common/js/global-config/mobile/default-config.js';
import '../_common/js/global-config/mobile/locale/zh_CN.js';
import '../_chunks/dep-4c6045f6.js';
import '@babel/runtime/helpers/typeof';
import '../_chunks/dep-1d280204.js';
import 'dayjs';
import '../_chunks/dep-5101c61a.js';
import '../config-provider/type.js';
import '../shared/functions.js';
import '../shared/constants.js';
import '../shared/useToggle/index.js';
import '../shared/useCountDown/index.js';
import '@babel/runtime/helpers/asyncToGenerator';
import '@babel/runtime/regenerator';
import '@vueuse/core';
import '../shared/useCountDown/utils.js';
import '../shared/useDefault/index.js';
import '../shared/useChildSlots/index.js';
import '../shared/useTouch/index.js';
import '../shared/useScrollParent/index.js';
import '../shared/useExpose/index.js';
import '../shared/useTest/index.js';
import '../shared/useClickAway/index.js';
import '../shared/useGesture/index.js';
import '@use-gesture/vanilla';
import '../shared/hover.js';
import '../popup/style';
import '../popup/type.js';
import '../tabs/props.js';
import '../tabs/tab-panel-props.js';
import '../sticky/index.js';
import '../sticky/props.js';
import '../sticky/style';
import '../sticky/type.js';
import '../badge/index.js';
import '../badge/props.js';
import '../badge/style';
import '../badge/type.js';
import '../tabs/style';
import '../tabs/type.js';
import '../radio/props.js';
import '../form/hooks.js';
import '../radio/radio-group-props.js';
import '../radio/style';
import '../radio/type.js';

var prefix = config.prefix;
var name = "".concat(prefix, "-cascader");
var childrenInfo = {
  value: "",
  level: 0
};
var script = defineComponent({
  name: name,
  components: {
    ChevronRightIcon: ChevronRightIcon,
    TNode: TNodeComponent,
    TPopup: _Popup,
    TTabs: Tabs,
    TTabPanel: TabPanel,
    TRadioGroup: RadioGroup
  },
  props: TdCascaderProps,
  emits: ["change", "close", "pick", "update:modelValue", "update:value", "update:visible"],
  setup: function setup(props, context) {
    var _options$value;
    var _useConfig = useConfig("cascader"),
      globalConfig = _useConfig.globalConfig;
    var _toRefs = toRefs(props),
      visible = _toRefs.visible,
      value = _toRefs.value,
      modelValue = _toRefs.modelValue,
      subTitles = _toRefs.subTitles,
      options = _toRefs.options,
      keys = _toRefs.keys,
      checkStrictly = _toRefs.checkStrictly;
    var open = ref(visible.value || false);
    var _useVModel = useVModel(value, modelValue, props.defaultValue, props.onChange),
      _useVModel2 = _slicedToArray(_useVModel, 2),
      cascaderValue = _useVModel2[0],
      setCascaderValue = _useVModel2[1];
    var title = computed(function () {
      return props.title || globalConfig.value.title;
    });
    var placeholder = computed(function () {
      return props.placeholder || globalConfig.value.placeholder;
    });
    var stepIndex = ref(0);
    var selectedIndexes = reactive([]);
    var selectedValue = reactive([]);
    var items = reactive([(_options$value = options.value) !== null && _options$value !== void 0 ? _options$value : []]);
    var steps = reactive([placeholder.value]);
    watch(placeholder, function (newValue, oldValue) {
      var index = steps.indexOf(oldValue);
      if (index !== -1) {
        steps[index] = newValue;
      }
    });
    onMounted(function () {
      initWithValue();
    });
    var internalInstance = getCurrentInstance();
    var closeBtnTNode = computed(function () {
      return renderTNode(internalInstance, "closeBtn", {
        defaultNode: h(CloseIcon, {
          size: "24px"
        })
      });
    });
    var titleTNode = computed(function () {
      return renderTNode(internalInstance, "title");
    });
    var placeholderTNode = computed(function () {
      return renderTNode(internalInstance, "placeholder");
    });
    var initWithValue = function initWithValue() {
      if (value.value != null) {
        steps.pop();
        var path = getIndexesByValue(options.value, value.value);
        path === null || path === void 0 || path.forEach(function (e) {
          selectedIndexes.push(e);
        });
        watchSelectedIndexes();
      }
    };
    var watchSelectedIndexes = function watchSelectedIndexes() {
      if (options.value && options.value.length > 0) {
        for (var i = 0, size = selectedIndexes.length; i < size; i += 1) {
          var _items$i, _keys$value$value, _keys$value, _keys$value$label, _keys$value2, _keys$value$children, _keys$value3;
          var index = selectedIndexes[i];
          var next = (_items$i = items[i]) === null || _items$i === void 0 ? void 0 : _items$i[index];
          selectedValue.push(next[(_keys$value$value = (_keys$value = keys.value) === null || _keys$value === void 0 ? void 0 : _keys$value.value) !== null && _keys$value$value !== void 0 ? _keys$value$value : "value"]);
          steps.push(next[(_keys$value$label = (_keys$value2 = keys.value) === null || _keys$value2 === void 0 ? void 0 : _keys$value2.label) !== null && _keys$value$label !== void 0 ? _keys$value$label : "label"]);
          if (next[(_keys$value$children = (_keys$value3 = keys.value) === null || _keys$value3 === void 0 ? void 0 : _keys$value3.children) !== null && _keys$value$children !== void 0 ? _keys$value$children : "children"]) {
            var _keys$value$children2, _keys$value4;
            items.push(next[(_keys$value$children2 = (_keys$value4 = keys.value) === null || _keys$value4 === void 0 ? void 0 : _keys$value4.children) !== null && _keys$value$children2 !== void 0 ? _keys$value$children2 : "children"]);
          }
        }
      }
      if (steps.length < items.length) {
        steps.push(placeholder.value);
      }
      stepIndex.value = items.length - 1;
    };
    var getIndexesByValue = function getIndexesByValue(options2, value2) {
      for (var i = 0; i < options2.length; i++) {
        var _keys$value$value2, _keys$value5, _keys$value$children3, _keys$value6;
        if (options2[i][(_keys$value$value2 = (_keys$value5 = keys.value) === null || _keys$value5 === void 0 ? void 0 : _keys$value5.value) !== null && _keys$value$value2 !== void 0 ? _keys$value$value2 : "value"] === value2) {
          return [i];
        }
        if (options2[i][(_keys$value$children3 = (_keys$value6 = keys.value) === null || _keys$value6 === void 0 ? void 0 : _keys$value6.children) !== null && _keys$value$children3 !== void 0 ? _keys$value$children3 : "children"]) {
          var _keys$value$children4, _keys$value7;
          var res = getIndexesByValue(options2[i][(_keys$value$children4 = (_keys$value7 = keys.value) === null || _keys$value7 === void 0 ? void 0 : _keys$value7.children) !== null && _keys$value$children4 !== void 0 ? _keys$value$children4 : "children"], value2);
          if (res) {
            return [i].concat(_toConsumableArray(res));
          }
        }
      }
    };
    var chooseSelect = function chooseSelect(e, level, index, item) {
      var _keys$value$label2, _keys$value8, _item, _keys$value$children5, _keys$value9, _item2, _keys$value$children7, _keys$value11;
      selectedIndexes[level] = index;
      selectedIndexes.length = level + 1;
      selectedValue[level] = String(e);
      selectedValue.length = level + 1;
      steps[level] = item[(_keys$value$label2 = (_keys$value8 = keys.value) === null || _keys$value8 === void 0 ? void 0 : _keys$value8.label) !== null && _keys$value$label2 !== void 0 ? _keys$value$label2 : "label"];
      if ((_item = item[(_keys$value$children5 = (_keys$value9 = keys.value) === null || _keys$value9 === void 0 ? void 0 : _keys$value9.children) !== null && _keys$value$children5 !== void 0 ? _keys$value$children5 : "children"]) !== null && _item !== void 0 && _item.length) {
        var _keys$value$children6, _keys$value10;
        items[level + 1] = item[(_keys$value$children6 = (_keys$value10 = keys.value) === null || _keys$value10 === void 0 ? void 0 : _keys$value10.children) !== null && _keys$value$children6 !== void 0 ? _keys$value$children6 : "children"];
        items.length = level + 2;
        stepIndex.value += 1;
        steps[level + 1] = placeholder.value;
        steps.length = level + 2;
      } else if (((_item2 = item[(_keys$value$children7 = (_keys$value11 = keys.value) === null || _keys$value11 === void 0 ? void 0 : _keys$value11.children) !== null && _keys$value$children7 !== void 0 ? _keys$value$children7 : "children"]) === null || _item2 === void 0 ? void 0 : _item2.length) === 0) {
        childrenInfo.value = e;
        childrenInfo.level = level;
      } else {
        var _keys$value$value3, _keys$value12;
        setCascaderValue(item[(_keys$value$value3 = (_keys$value12 = keys.value) === null || _keys$value12 === void 0 ? void 0 : _keys$value12.value) !== null && _keys$value$value3 !== void 0 ? _keys$value$value3 : "value"], items.map(function (item2, index2) {
          return toRaw(item2 === null || item2 === void 0 ? void 0 : item2[selectedIndexes[index2]]);
        }));
        close("finish");
      }
    };
    var cancelSelect = function cancelSelect(e, level, index, item) {
      var _item3, _keys$value$children8, _keys$value13, _item4, _keys$value$children10, _keys$value15;
      selectedIndexes[level] = index;
      selectedIndexes.length = level;
      selectedValue.length = level;
      steps[level] = String(placeholder.value);
      steps[level + 1] = placeholder.value;
      steps.length = level + 1;
      if ((_item3 = item[(_keys$value$children8 = (_keys$value13 = keys.value) === null || _keys$value13 === void 0 ? void 0 : _keys$value13.children) !== null && _keys$value$children8 !== void 0 ? _keys$value$children8 : "children"]) !== null && _item3 !== void 0 && _item3.length) {
        var _keys$value$children9, _keys$value14;
        items[level + 1] = item[(_keys$value$children9 = (_keys$value14 = keys.value) === null || _keys$value14 === void 0 ? void 0 : _keys$value14.children) !== null && _keys$value$children9 !== void 0 ? _keys$value$children9 : "children"];
      } else if (((_item4 = item[(_keys$value$children10 = (_keys$value15 = keys.value) === null || _keys$value15 === void 0 ? void 0 : _keys$value15.children) !== null && _keys$value$children10 !== void 0 ? _keys$value$children10 : "children"]) === null || _item4 === void 0 ? void 0 : _item4.length) === 0) {
        childrenInfo.value = e;
        childrenInfo.level = level;
      }
    };
    var handleSelect = function handleSelect(e, level) {
      var _props$onPick, _keys$value$value5, _keys$value17;
      var value2 = e;
      var index = items[level].findIndex(function (item2) {
        var _keys$value$value4, _keys$value16;
        return item2[(_keys$value$value4 = (_keys$value16 = keys.value) === null || _keys$value16 === void 0 ? void 0 : _keys$value16.value) !== null && _keys$value$value4 !== void 0 ? _keys$value$value4 : "value"] === value2;
      });
      var item = items[level][index];
      if (item.disabled) {
        return;
      }
      (_props$onPick = props.onPick) === null || _props$onPick === void 0 || _props$onPick.call(props, {
        level: level,
        value: item[(_keys$value$value5 = (_keys$value17 = keys.value) === null || _keys$value17 === void 0 ? void 0 : _keys$value17.value) !== null && _keys$value$value5 !== void 0 ? _keys$value$value5 : "value"],
        index: index
      });
      if (checkStrictly.value && selectedValue.includes(String(value2))) {
        cancelSelect(e, level, index, item);
      } else {
        chooseSelect(e, level, index, item);
      }
    };
    watch(open, function () {
      context.emit("update:visible", open.value);
    });
    watch(visible, function () {
      open.value = visible.value;
    });
    watch(function () {
      return props.options;
    }, function () {
      if (open.value) {
        handleSelect(childrenInfo.value, childrenInfo.level);
      }
    }, {
      deep: true
    });
    var close = function close(trigger) {
      var _props$onClose;
      (_props$onClose = props.onClose) === null || _props$onClose === void 0 || _props$onClose.call(props, {
        trigger: trigger
      });
    };
    var onVisibleChange = function onVisibleChange(visible2, e) {
      if ((e === null || e === void 0 ? void 0 : e.trigger) !== "overlay") return;
      close("overlay");
    };
    var updateCascaderValue = function updateCascaderValue() {
      setCascaderValue(selectedValue[selectedValue.length - 1], items.filter(function (item, index) {
        return !!item && selectedIndexes.length > index;
      }).map(function (item, index) {
        return toRaw(item === null || item === void 0 ? void 0 : item[selectedIndexes[index]]);
      }));
    };
    var onClose = function onClose() {
      open.value = false;
      close("close-btn");
    };
    var onCloseBtn = function onCloseBtn() {
      if (checkStrictly.value) {
        updateCascaderValue();
        onClose();
      } else {
        onClose();
      }
    };
    var onStepClick = function onStepClick(index) {
      stepIndex.value = index;
    };
    var onTabChange = function onTabChange(value2) {
      stepIndex.value = Number(value2);
    };
    return {
      open: open,
      placeholder: placeholder,
      onVisibleChange: onVisibleChange,
      onStepClick: onStepClick,
      onTabChange: onTabChange,
      handleSelect: handleSelect,
      closeBtnTNode: closeBtnTNode,
      titleTNode: titleTNode,
      placeholderTNode: placeholderTNode,
      stepIndex: stepIndex,
      name: name,
      title: title,
      subTitles: subTitles,
      cascaderValue: cascaderValue,
      steps: steps,
      selectedValue: selectedValue,
      selectedIndexes: selectedIndexes,
      items: items,
      setCascaderValue: setCascaderValue,
      onClose: onClose,
      onCloseBtn: onCloseBtn
    };
  }
});

var _hoisted_1 = {
  key: 0
};
var _hoisted_2 = ["onClick"];
var _hoisted_3 = {
  key: 1
};
function render(_ctx, _cache, $props, $setup, $data, $options) {
  var _component_t_node = resolveComponent("t-node");
  var _component_chevron_right_icon = resolveComponent("chevron-right-icon");
  var _component_t_tab_panel = resolveComponent("t-tab-panel");
  var _component_t_tabs = resolveComponent("t-tabs");
  var _component_t_radio_group = resolveComponent("t-radio-group");
  var _component_t_popup = resolveComponent("t-popup");
  return openBlock(), createBlock(_component_t_popup, {
    modelValue: _ctx.open,
    "onUpdate:modelValue": _cache[1] || (_cache[1] = function ($event) {
      return _ctx.open = $event;
    }),
    placement: "bottom",
    onVisibleChange: _ctx.onVisibleChange
  }, {
    default: withCtx(function () {
      return [createElementVNode("div", {
        class: normalizeClass("".concat(_ctx.name))
      }, [createElementVNode("div", {
        class: normalizeClass("".concat(_ctx.name, "__title"))
      }, [!(typeof _ctx.titleTNode === "string") ? (openBlock(), createBlock(_component_t_node, {
        key: 0,
        content: _ctx.titleTNode
      }, null, 8, ["content"])) : (openBlock(), createElementBlock(Fragment, {
        key: 1
      }, [createTextVNode(toDisplayString(_ctx.title), 1)], 64))], 2), createElementVNode("div", {
        class: normalizeClass("".concat(_ctx.name, "__close-btn")),
        onClick: _cache[0] || (_cache[0] = function () {
          return _ctx.onCloseBtn && _ctx.onCloseBtn.apply(_ctx, arguments);
        })
      }, [_ctx.closeBtnTNode ? (openBlock(), createBlock(_component_t_node, {
        key: 0,
        content: _ctx.closeBtnTNode
      }, null, 8, ["content"])) : createCommentVNode("", true)], 2), createElementVNode("div", {
        class: normalizeClass("".concat(_ctx.name, "__content"))
      }, [_ctx.steps && _ctx.steps.length ? (openBlock(), createElementBlock("div", _hoisted_1, [_ctx.theme === "step" ? (openBlock(), createElementBlock("div", {
        key: 0,
        class: normalizeClass("".concat(_ctx.name, "__steps"))
      }, [(openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.steps, function (item, index) {
        return openBlock(), createElementBlock("div", {
          key: index,
          class: normalizeClass("".concat(_ctx.name, "__step")),
          onClick: function onClick($event) {
            return _ctx.onStepClick(index);
          }
        }, [createElementVNode("div", {
          class: normalizeClass(["".concat(_ctx.name, "__step-dot"), {
            "t-cascader__step-dot--active": item !== _ctx.placeholder,
            "t-cascader__step-dot--last": index === _ctx.steps.length - 1
          }])
        }, null, 2), createElementVNode("div", {
          class: normalizeClass(["".concat(_ctx.name, "__step-label"), {
            "t-cascader__step-label--active": index === _ctx.stepIndex
          }])
        }, [_ctx.placeholderTNode && !(typeof _ctx.placeholderTNode === "string") && item === _ctx.placeholder ? (openBlock(), createBlock(_component_t_node, {
          key: 0,
          content: _ctx.placeholderTNode
        }, null, 8, ["content"])) : (openBlock(), createElementBlock(Fragment, {
          key: 1
        }, [createTextVNode(toDisplayString(item), 1)], 64))], 2), createVNode(_component_chevron_right_icon, {
          class: normalizeClass("".concat(_ctx.name, "__step-arrow")),
          size: "22"
        }, null, 8, ["class"])], 10, _hoisted_2);
      }), 128))], 2)) : createCommentVNode("", true), _ctx.open && _ctx.theme === "tab" ? (openBlock(), createElementBlock("div", _hoisted_3, [createVNode(_component_t_tabs, {
        id: "tabs",
        value: _ctx.stepIndex,
        "space-evenly": false,
        onChange: _ctx.onTabChange
      }, {
        default: withCtx(function () {
          return [(openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.steps, function (item, index) {
            return openBlock(), createBlock(_component_t_tab_panel, {
              key: index,
              value: index,
              label: item
            }, null, 8, ["value", "label"]);
          }), 128))];
        }),
        _: 1
      }, 8, ["value", "onChange"])])) : createCommentVNode("", true)])) : createCommentVNode("", true), _ctx.subTitles && _ctx.subTitles[_ctx.stepIndex] ? (openBlock(), createElementBlock("div", {
        key: 1,
        class: normalizeClass("".concat(_ctx.name, "__options-title"))
      }, toDisplayString(_ctx.subTitles[_ctx.stepIndex]), 3)) : createCommentVNode("", true), createElementVNode("div", {
        class: normalizeClass("".concat(_ctx.name, "__options-container")),
        style: normalizeStyle("width: ".concat(_ctx.items.length + 1, "00vw; transform: translateX(-").concat(_ctx.stepIndex, "00vw);"))
      }, [(openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.items, function (options, index) {
        return openBlock(), createElementBlock("div", {
          key: index,
          class: normalizeClass("".concat(_ctx.name, "__options"))
        }, [createVNode(Transition, {
          appear: "",
          name: "slide"
        }, {
          default: withCtx(function () {
            return [createElementVNode("div", {
              class: normalizeClass("cascader-radio-group-".concat(index))
            }, [createVNode(_component_t_radio_group, {
              value: _ctx.selectedValue[index] || "",
              keys: _ctx.keys,
              options: options,
              placement: "right",
              icon: "line",
              borderless: "",
              onChange: function onChange($event) {
                return _ctx.handleSelect($event, index);
              }
            }, null, 8, ["value", "keys", "options", "onChange"])], 2)];
          }),
          _: 2
        }, 1024)], 2);
      }), 128))], 6)], 2)], 2)];
    }),
    _: 1
  }, 8, ["modelValue", "onVisibleChange"]);
}

script.render = render;

export { script as default };
//# sourceMappingURL=cascader.js.map
